Ù†Ø¬Ø­Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ù† Ø³ÙˆÙ Ù†Ø¹Ù…Ù„ Ø¹Ù„ÙŠ Ø¬Ø²Ø¡ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø¨Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ù„ÙƒÙ† Ø§Ø¨Ø³Ø· Ø¹Ù†Ø¯ ØªÙ‚Ø¯ÙŠÙ… Ù„Ù„ÙˆØ¸ÙŠÙØ© Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„ÙÙˆØ±Ù… Ø§Ù„Ù…Ø®ÙÙŠ ÙÙŠ listing-job  ÙŠØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµØ§Ø­Ø¨ Ø§Ø¹Ù„Ø§Ù† Ø§Ù„ÙˆØ¸ÙŠÙØ© ÙÙ‚Ø· ÙÙŠ ØµÙØ­Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØ¸ÙŠÙ Ù…Ø¹ ØµÙˆØ±Ø© Ø§ÙØªØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ Ø§Ø±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹ Ø§Ù…ÙƒØ§Ù†ÙŠØ© Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠ Ø§Ø³Ù…Ù‡ Ø§Ùˆ ØµÙˆØ±Ø© Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ù‡ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø§Ø±Ø³Ø§Ù„Ù‡Ø§ ÙÙŠ Ø§Ù„ÙÙˆØ±Ù… Ù„ÙŠØ³ Ù„Ø¯ÙŠ ØµÙØ­Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§ÙƒÙˆØ§Ø¯ <!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ù…Ù„ Ø¹Ù† Ø¨Ø¹Ø¯</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
      :root {
        --primary: #1e3a8a; /* Ø£Ø²Ø±Ù‚ Ø¯Ø§ÙƒÙ† */
        --secondary: #10b981; /* Ø£Ø®Ø¶Ø± Ø¹ØµØ±ÙŠ */
        --accent: #f59e0b; /* Ù„Ù…Ø³Ø© Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠØ©/ØµÙØ±Ø§Ø¡ */
        --background-color: #f4f7fa; /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© */
        --card-bg: #ffffff; /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        --text-color: #333333; /* Ù„ÙˆÙ† Ù†Øµ Ø¯Ø§ÙƒÙ† */
        --border-radius: 8px;
        --transition: 0.3s ease;
      }

      /* Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Tajawal", sans-serif;
      }

      body {
        background-color: var(--background-color);
        color: var(--text-color);
      }

      a {
        text-decoration: none;
        color: inherit;
      }

      /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
      header {
        background: linear-gradient(135deg, var(--primary), #3158b0);
        color: #fff;
        padding: 20px;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      header h1 {
        font-size: 2.2em;
        font-weight: 700;
      }

      /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
      .container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 20px;
      }

      /* Ù‚Ø§Ø¦Ù…Ø© Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù */
      .job-grid {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆØ¸ÙŠÙØ© (ØªØµÙ…ÙŠÙ… Ø¹Ø±Ø¶ÙŠ) */
      .job-card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 15px 20px;
        transition: transform var(--transition), box-shadow var(--transition);
        display: flex;
        align-items: center;
        justify-content: space-between; /* Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠØ³Ø§Ø± ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„ Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙ…ÙŠÙ† */
        max-width: 100%;
      }
      .job-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙˆØ¸ÙŠÙØ© */
      .job-icon-container {
        flex-shrink: 0;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--secondary);
        border-radius: 50%;
        color: #fff;
        font-size: 1.8em;
      }

      /* ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ© */
      .job-details {
        flex: 1;
        text-align: right;
      }
      .job-details h3 {
        font-size: 1.5em;
        color: var(--primary);
        margin-bottom: 5px;
      }
      .job-meta {
        font-size: 0.9em;
        color: #777;
        margin-bottom: 10px;
      }
      .job-meta span {
        margin-right: 10px;
      }
      .job-details p {
        font-size: 1em;
        margin-bottom: 10px;
      }
      .apply-btn {
        display: inline-block;
        padding: 10px 15px;
        background: var(--secondary);
        color: #fff;
        border-radius: var(--border-radius);
        font-size: 1em;
        transition: background var(--transition), transform var(--transition);
        border: none;
        cursor: pointer;
      }
      .apply-btn i {
        margin-left: 5px;
      }
      .apply-btn:hover {
        background: #0e9d75;
        transform: scale(1.03);
      }

      /* ØªØµÙ…ÙŠÙ… Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… (Ù…ÙˆØ¯Ø§Ù„) */
      .hidden-form {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 30px;
        width: 90%;
        max-width: 500px;
        z-index: 150;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        animation: fadeIn 0.3s ease-out;
      }
      .hidden-form.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translate(-50%, -45%);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%);
        }
      }
      .hidden-form input,
      .hidden-form textarea {
        width: 100%;
        padding: 12px 15px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
        font-size: 1em;
        transition: border-color var(--transition);
      }
      .hidden-form input:focus,
      .hidden-form textarea:focus {
        border-color: var(--primary);
        outline: none;
      }
      .hidden-form button[type="submit"] {
        width: 100%;
        padding: 12px;
        background: var(--accent);
        border: none;
        border-radius: var(--border-radius);
        font-size: 1em;
        font-weight: bold;
        color: #fff;
        cursor: pointer;
        transition: background var(--transition);
      }
      .hidden-form button[type="submit"]:hover {
        background: #d98806;
      }

      /* Ø®Ù„ÙÙŠØ© Ø§Ù„ØªØ¹ØªÙŠÙ… Ù„Ù„Ù…ÙˆØ¯Ø§Ù„ */
      .modal-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 100;
        animation: fadeInBackdrop 0.3s ease-out;
      }
      .modal-backdrop.active {
        display: block;
      }
      @keyframes fadeInBackdrop {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
      .close-modal {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 1.5em;
        color: var(--primary);
        cursor: pointer;
      }

      /* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© */
      @media (max-width: 768px) {
        header h1 {
          font-size: 1.8em;
        }
        .job-card {
          flex-direction: column;
          align-items: flex-start;
        }
        .job-icon-container {
          width: 50px;
          height: 50px;
          font-size: 1.2em;
        }
        .job-details {
          text-align: left;
          width: 100%;
        }
        .apply-btn {
          align-self: stretch;
        }
      }
    </style>
  </head>
  <%- include('partials/headerhome') %> <%- include('partials/headeraction') %>
  <body>
    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù -->
    <div class="container">
      <div class="job-grid">
        <% jobs.forEach(function(job) { %>
        <div class="job-card">
          <!-- Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠØ³Ø§Ø± -->
          <div class="job-icon-container">
            <i class="fas fa-briefcase"></i>
          </div>
          <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙ…ÙŠÙ† -->
          <div class="job-details">
            <h3><%= job.title %></h3>
            <div class="job-meta">
              <span><i class="fas fa-clock"></i> <%= job.job_type %></span>
              <span
                ><i class="fas fa-map-marker-alt"></i> <%= job.location %></span
              >
            </div>
            <p><strong>Ø§Ù„ÙˆØµÙ:</strong> <%= job.description %></p>
            <p>
              <strong>Ø§Ù„Ø±Ø§ØªØ¨:</strong>
              <%= job.salary_min ? job.salary_min + " - " + job.salary_max + " "
              + job.currency : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯" %>
            </p>
            <button class="apply-btn" onclick="openModal('<%= job.job_id %>')">
              Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… Ù„Ù„ÙˆØ¸ÙŠÙØ© <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
        <% }); %>
      </div>
    </div>

    <!-- Ø®Ù„ÙÙŠØ© Ø§Ù„ØªØ¹ØªÙŠÙ… Ù„Ù„Ù…ÙˆØ¯Ø§Ù„ -->
    <div id="modal-backdrop" class="modal-backdrop"></div>

    <!-- Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… Ù„ÙƒÙ„ ÙˆØ¸ÙŠÙØ© -->
    <% jobs.forEach(function(job) { %>
    <div id="modal-<%= job.job_id %>" class="hidden-form">
      <button class="close-modal" onclick="closeModal('<%= job.job_id %>')">
        &times;
      </button>
      <form onsubmit="submitApplication(event, '<%= job.job_id %>')">
        <input type="hidden" name="job_id" value="<%= job.job_id %>" />
        <input type="text" name="applicant_name" placeholder="Ø§Ø³Ù…Ùƒ" required />
        <input
          type="email"
          name="applicant_email"
          placeholder="Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
          required
        />
        <textarea
          name="cover_letter"
          placeholder="Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…"
          required
        ></textarea>
        <button type="submit">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
      </form>
    </div>
    <% }); %>

    <script>
      function openModal(jobId) {
        document.getElementById("modal-" + jobId).classList.add("active");
        document.getElementById("modal-backdrop").classList.add("active");
      }
      function closeModal(jobId) {
        document.getElementById("modal-" + jobId).classList.remove("active");
        document.getElementById("modal-backdrop").classList.remove("active");
      }
      async function submitApplication(event, jobId) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        try {
          const response = await fetch("/apply/" + jobId, {
            method: "POST",
            body: formData,
          });
          const result = await response.json();
          if (response.ok) {
            alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
            form.reset();
            closeModal(jobId);
          } else {
            alert("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: " + result.message);
          }
        } catch (error) {
          console.error("Error during submission:", error);
          alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
        }
      }
    </script>
    <footer style="margin-top: 24vh"><%- include('partials/footer') %></footer>
  </body>
</html>
 Ùˆ const express = require("express");
const router = express.Router();
const JobController = require("../controllers/jobControllers");
const fs = require("fs");
const multer = require("multer");
const path = require("path");

// ğŸ“Œ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³Ø§Ø±Ø§Øª ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª
const uploadDir = path.resolve(__dirname, "../uploads/picjobs");
const cvDir = path.resolve(__dirname, "../uploads/cvs");

// âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
[uploadDir, cvDir].forEach((dir) => {
  try {
    if (!fs.existsSync(dir)) {
      fs.mkdirSync(dir, { recursive: true });
      console.log(`ğŸ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯: ${dir}`);
    }
  } catch (error) {
    console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯ ${dir}:`, error);
  }
});

// ğŸ“Œ Ø¥Ø¹Ø¯Ø§Ø¯ multer Ù„ØªØ­Ù…ÙŠÙ„ ØµÙˆØ± Ø§Ù„ÙˆØ¸Ø§Ø¦Ù
const storage = multer.diskStorage({
  destination: (req, file, cb) => cb(null, uploadDir),
  filename: (req, file, cb) => {
    const filename = Date.now() + path.extname(file.originalname);
    console.log(`ğŸ“· Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ÙˆØ¸ÙŠÙØ©: ${filename}`);
    cb(null, filename);
  },
});
const upload = multer({ storage });

// ğŸŒŸ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù

// Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆØ¸ÙŠÙØ©
router.post(
  "/jobs/add",
  upload.single("logo"),
  (req, res, next) => {
    console.log("ğŸ“Œ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©:", req.body);
    console.log("ğŸ“· Ù…Ù„Ù Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…:", req.file);

    // Ø¥Ø°Ø§ ÙƒØ§Ù† userId ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ req.userØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ…Ø±ÙŠØ±Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø¹Ø¨Ø± req.body
    if (!req.user) {
      req.user = { id: req.body.userId }; // ØªØ¹ÙŠÙŠÙ† req.user ÙŠØ¯ÙˆÙŠÙ‹Ø§
    }

    next();
  },
  JobController.addJob
);

// ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ ÙˆØ¸ÙŠÙØ© (ÙŠÙØ®Ø²Ù† ÙÙ‚Ø· Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚)
// Ù†Ø³ØªØ®Ø¯Ù… multer().none() Ù„ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù€ FormData Ø¯ÙˆÙ† Ù…Ù„ÙØ§Øª
router.post("/apply/:jobId", multer().none(), JobController.applyJob);

// Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (API)
router.get("/jobPage/all", JobController.getAllJobs);

// Ø¬Ù„Ø¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØ¸ÙŠÙ Ù„ÙˆØ¸ÙŠÙØ© Ù…Ø¹ÙŠÙ†Ø© (API)
router.get("/applications/:jobId", JobController.getApplications);

// Ø¹Ø±Ø¶ ØµÙØ­Ø§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (Rendering)
router.get("/jobs", (req, res) => res.render("jobs"));
router.get("/add-job", (req, res) => res.render("add-job"));

// Ø¹Ø±Ø¶ ØµÙØ­Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø¨ØªÙØ§ØµÙŠÙ„Ù‡Ø§
router.get("/listing-job", JobController.renderAllJobs);

// Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØ¸ÙŠÙ:
// Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¹Ø±Ù Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ ØªØ¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª ØªÙ„Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙØ© ÙÙ‚Ø·
// Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ØŒ ØªØ¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ®ØµÙŠØµ Ù‡Ø°Ø§ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©)
router.get("/jobapplications/:jobId?", JobController.renderAllApplications);

// Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡Ø§
router.get("/job/:jobId", JobController.renderJobDetail);

module.exports = router; Ùˆ const db = require("../config/db");

class JobModel {
  // Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ø¬Ø¯ÙŠØ¯Ø©
  static async addJob(jobData) {
    const sql = `
      INSERT INTO jobs 
      (title, description, job_type, education, currency, salary_min, salary_max, salary_after_interview, location, experience, duration, logo, expires_at, user_id)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `;
  
    const values = [
      jobData.title,
      jobData.description,
      jobData.jobType,
      jobData.education,
      jobData.currency,
      jobData.salaryMin,
      jobData.salaryMax,
      jobData.salaryAfterInterview || 0,
      jobData.location,
      jobData.experience,
      jobData.duration,
      jobData.logo,
      jobData.expiresAt,
      jobData.userId,
    ];
  
    return new Promise((resolve, reject) => {
      db.query(sql, values, (err, results) => {
        if (err) {
          console.error("âŒ Database Error:", err);
          reject(err);
        } else {
          console.log("âœ… Job added with ID:", results.insertId);
          resolve(results.insertId);
        }
      });
    });
  }
  

  // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  static async getAllJobs() {
    const sql = `
      SELECT 
        j.job_id, j.title, j.description, j.job_type, j.education, j.currency, 
        j.salary_min, j.salary_max, j.salary_after_interview, 
        j.location, j.experience, j.duration, j.created_at, j.expires_at,
        u.name AS user_name, u.avatar AS user_avatar
      FROM jobs j
      LEFT JOIN users u ON j.owner_id = u.id
      ORDER BY j.created_at DESC
    `;
    return new Promise((resolve, reject) => {
      db.query(sql, (err, results) => {
        if (err) {
          reject(err);
        } else {
          resolve(results);
        }
      });
    });
  }

  // Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ ØªÙˆØ¸ÙŠÙ Ø¬Ø¯ÙŠØ¯
  static async addApplication(jobId, applicantName, applicantEmail, coverLetter) {
    const sql = `
      INSERT INTO job_applications 
      (job_id, applicant_name, applicant_email, cover_letter) 
      VALUES (?, ?, ?, ?)
    `;
    return new Promise((resolve, reject) => {
      db.query(sql, [jobId, applicantName, applicantEmail, coverLetter], (err, results) => {
        if (err) {
          reject(err);
        } else {
          resolve(results);
        }
      });
    });
  }

  // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØ¸ÙŠÙ Ù„ÙˆØ¸ÙŠÙØ© Ù…Ø¹ÙŠÙ†Ø©
  static async getApplicationsByJob(jobId) {
    const sql = `
      SELECT * FROM job_applications 
      WHERE job_id = ? 
      ORDER BY created_at DESC
    `;
    return new Promise((resolve, reject) => {
      db.query(sql, [jobId], (err, results) => {
        if (err) {
          reject(err);
        } else {
          resolve(results);
        }
      });
    });
  }

  // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØ¸ÙŠÙ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ©
  static async getAllApplications() {
    const sql = `
      SELECT 
        ja.application_id, ja.job_id, ja.applicant_name, ja.applicant_email, ja.cover_letter, ja.created_at,
        j.title AS job_title, j.location AS job_location
      FROM job_applications ja
      LEFT JOIN jobs j ON ja.job_id = j.job_id
      ORDER BY ja.created_at DESC
    `;
    return new Promise((resolve, reject) => {
      db.query(sql, (err, results) => {
        if (err) {
          reject(err);
        } else {
          resolve(results);
        }
      });
    });
  }

  // Ø­Ø°Ù Ø·Ù„Ø¨ ØªÙˆØ¸ÙŠÙ Ù…Ø¹ÙŠÙ†
  static async deleteApplication(applicationId) {
    const sql = `DELETE FROM job_applications WHERE application_id = ?`;
    return new Promise((resolve, reject) => {
      db.query(sql, [applicationId], (err, results) => {
        if (err) {
          reject(err);
        } else {
          resolve(results);
        }
      });
    });
  }

  // Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ ÙˆØ¸ÙŠÙØ© Ù…Ø¹ÙŠÙ†Ø©
  static async getJobDetail(jobId) {
    const sql = `
      SELECT 
        j.*, 
        u.name AS user_name, u.avatar AS user_avatar
      FROM jobs j
      LEFT JOIN users u ON j.user_id = u.id
      WHERE j.job_id = ?
    `;
    return new Promise((resolve, reject) => {
      db.query(sql, [jobId], (err, results) => {
        if (err) {
          reject(err);
        } else {
          resolve(results[0]);
        }
      });
    });
  }
}

module.exports = JobModel; Ùˆ const JobModel = require("../models/jobModel");


class JobController {
  // Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ø¬Ø¯ÙŠØ¯Ø©
  static async addJob(req, res) {
    try {
      const jobData = {
        ...req.body,
        salaryMin: parseFloat(req.body.salaryMin),
        salaryMax: parseFloat(req.body.salaryMax),
        duration: parseInt(req.body.duration, 10) || 0,
        logo: req.file?.filename ?? null,
        expiresAt: req.body.duration
          ? new Date(Date.now() + req.body.duration * 86400000).toISOString()
          : null,
      };

      const jobId = await JobModel.addJob(jobData);
      console.log("ğŸš€ Job added with ID:", jobId);

     
      res.status(201).json({
        success: true,
        message: "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø¨Ù†Ø¬Ø§Ø­!",
        redirectUrl: "listing-job"
      });
    } catch (err) {
      console.error("âŒ Error adding job:", err);
      res.status(500).json({
        success: false,
        message: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¸ÙŠÙØ©.",
      });
    }
  }


  // API: Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ÙˆØ¥Ø±Ø¬Ø§Ø¹Ù‡Ø§ ÙƒÙ€ JSON
  static async getAllJobs(req, res) {
    try {
      const jobs = await JobModel.getAllJobs();
      res.json(jobs);
    } catch (error) {
      console.error("âŒ Error fetching jobs:", error);
      res.status(500).json({ error: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù." });
    }
  }

  // Render: Ø¹Ø±Ø¶ ØµÙØ­Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  static async renderAllJobs(req, res) {
    try {
      const jobs = await JobModel.getAllJobs();
      res.render("listing-job", { jobs });
    } catch (error) {
      console.error("âŒ Error rendering jobs:", error);
      res.status(500).send("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù.");
    }
  }

  // ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ ÙˆØ¸ÙŠÙØ© (ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚ ÙÙ‚Ø·)
  static async applyJob(req, res) {
    try {
      const { jobId } = req.params;
      const { applicant_name, applicant_email, cover_letter } = req.body;

      console.log("Received application:", {
        jobId,
        applicant_name,
        applicant_email,
        cover_letter,
      });

      if (!jobId || !applicant_name || !applicant_email || !cover_letter) {
        console.error("Missing required fields in application:", {
          jobId,
          applicant_name,
          applicant_email,
          cover_letter,
        });
        return res.status(400).json({ message: "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©!" });
      }

      await new Promise((resolve, reject) => {
        JobModel.addApplication(
          jobId,
          applicant_name,
          applicant_email,
          cover_letter,
          (err, result) => {
            if (err) {
              console.error("Database error in addApplication:", err);
              reject(err);
            } else {
              resolve(result);
            }
          }
        );
      });

      console.log("Application submitted successfully.");
      res.json({ success: true, message: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!" });
    } catch (err) {
      console.error("âŒ Error submitting application:", err);
      res.status(500).json({ error: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨." });
    }
  }

  // API: Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„ÙˆØ¸ÙŠÙØ© Ù…Ø¹ÙŠÙ†Ø© ÙˆØ¥Ø±Ø¬Ø§Ø¹Ù‡Ø§ ÙƒÙ€ JSON
  static async getApplications(req, res) {
    try {
      const { jobId } = req.params;
      await new Promise((resolve, reject) => {
        JobModel.getApplicationsByJob(jobId, (err, applications) => {
          if (err) {
            reject(err);
          } else {
            resolve(applications);
          }
        });
      }).then((applications) => {
        res.json(applications);
      });
    } catch (err) {
      console.error("âŒ Error fetching applications:", err);
      res.status(500).json({ error: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª." });
    }
  }

  // Render: Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØ¸ÙŠÙ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†)
  static async renderAllApplications(req, res) {
    try {
      const { jobId } = req.params;
      await new Promise((resolve, reject) => {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¹Ø±Ù Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø§ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø³ØªØ¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        if (jobId) {
          JobModel.getApplicationsByJob(jobId, (err, applications) => {
            if (err) {
              reject(err);
            } else {
              resolve(applications);
            }
          });
        } else {
          JobModel.getAllApplications((err, applications) => {
            if (err) {
              reject(err);
            } else {
              resolve(applications);
            }
          });
        }
      }).then((applications) => {
        res.render("jobapplications", { applications });
      });
    } catch (err) {
      console.error("âŒ Error rendering applications:", err);
      res.status(500).send("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØ¸ÙŠÙ.");
    }
  }

  // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ©
  static async renderJobDetail(req, res) {
    try {
      const { jobId } = req.params;
      const job = await JobModel.getJobDetail(jobId);
      if (!job) {
        return res.status(404).send("Job not found");
      }
      res.render("jobDetail", { job });
    } catch (error) {
      console.error("Error rendering job detail:", error);
      res.status(500).send("An error occurred while fetching job details.");
    }
  }
}

module.exports = JobController;